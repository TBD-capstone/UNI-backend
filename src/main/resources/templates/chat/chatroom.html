<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>채팅방</title>
  <!-- SockJS와 STOMP 자바스크립트 라이브러리 로드 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>채팅방</h1>

<!-- 메시지 표시 영역 -->
<div id="messages">
  <div th:each="message : ${chatMessages}">
    <p th:text="${message.senderId == myId ? '나' : '상대방'}"></p>
    <p th:text="${message.content}"></p>
    <p th:text="${message.sendAt}"></p>
  </div>
</div>

<!-- 메시지 전송 폼 -->
<form id="chatForm" method="post">
  <input type="text" id="message" name="message" placeholder="메시지를 입력하세요" />
  <button type="submit">메시지 보내기</button>
</form>

<script th:inline="javascript">
  const roomId = /*[[${chatRoomId}]]*/;
  const myId = /*[[${myId}]]*/;  // myId 변수를 자바스크립트에서 안전하게 사용할 수 있도록 설정
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let stompClient = null;

    // WebSocket 연결 열기
    const connect = async () => {
      try {
        const socket = new SockJS('/ws/chat');  // SockJS 엔드포인트
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
          console.log(`Connected: ${frame}`);

          // 채팅방 구독
          stompClient.subscribe(`/sub/chat/room/${roomId}`, (messageOutput) => {
            const message = JSON.parse(messageOutput.body);
            showMessage(message);
          });
        }, (error) => {
          console.error('WebSocket 연결 실패: ', error);
        });
      } catch (error) {
        console.error('WebSocket 연결 중 에러 발생: ', error);
      }
    };

    // 메시지 표시하기
    const showMessage = (message) => {
      const messagesDiv = document.getElementById('messages');
      const messageElement = document.createElement('div');

      // myId와 message.senderId 비교하여 나와 상대방 구분
      const senderName = (message.senderId == myId) ? '나' : '상대방';

      messageElement.innerHTML = `<p>${senderName}: ${message.content}</p>`;
      messagesDiv.appendChild(messageElement);
    };

    // 메시지 전송
    document.getElementById('chatForm').addEventListener('submit', async (event) => {
      event.preventDefault();

      const messageContent = document.getElementById('message').value.trim();
      if (messageContent && stompClient) {
        const chatMessage = {
          senderId: myId,
          roomId: roomId,
          content: messageContent
        };

        stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
        document.getElementById('message').value = ''; // 메시지 전송 후 입력 창 비우기
      }
    });

    connect();  // WebSocket 연결 시도
  });
</script>

</body>
</html>
